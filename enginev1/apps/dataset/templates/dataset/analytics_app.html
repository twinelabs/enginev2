{% load staticfiles %}

<!DOCTYPE html>
<!--[if lt IE 7]>      <html lang="en" ng-app="dashApp" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html lang="en" ng-app="dashApp" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html lang="en" ng-app="dashApp" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en" ng-app="dashApp" class="no-js"> <!--<![endif]-->
<html lang="en" ng-app="dashApp">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Twine Labs Dashboard</title>

  <link href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="http://cdnjs.cloudflare.com/ajax/libs/angular-ui-grid/3.2.6/ui-grid.min.css" rel="stylesheet"/>
  <link href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"/>

    <link href="{% static "css/bootstrap.min.css" %}" rel="stylesheet">
    <link href="{% static "css/styles.min.css" %}" rel="stylesheet">

  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <!--<script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-grid/3.2.6/ui-grid.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

  <script type="text/javascript">
'use strict';

angular
  .module('dashApp', ['ui.grid'])
  .controller('dashCtrl', dashCtrl);

dashCtrl.$inject = [ '$scope', '$timeout' ];

function dashCtrl($scope, $timeout){
  var _ = this;

  // TABLES
  _.tables = [];
  _.selectedTable = _.tables[0];

  // VIEWS
  _.views = [
    {
      id: 0,
      name: 'Summary'
    },
    {
      id: 1,
      name: 'Charts'
    },
    {
      id: 2,
      name: 'Statistics'
    }
  ];
  _.selectedView = _.views[1];

  // DATA
  _.data = [];
  _.dataFields = [];
  _.dataFieldsByType = {
    string: {
      fields: [],
      open: true,
      name: 'String Fields'
    },
    numeric: {
      fields: [],
      open: false,
      name: 'Numeric Fields'
    },
    date: {
      fields: [],
      open: false,
      name: 'Date Fields'
    }
  };
  _.selectedDataField;

  // CHARTS
  _.charts = {};
  _.chartData = null;

  // CHART CONTROLS
  _.chartControlSort = [
    {
      id: 0,
      name: 'desc'
    },
    {
      id: 1,
      name: 'asc'
    },
    {
      id: 2,
      name: 'abc'
    }
  ];
  _.selectedChartControlSort = _.chartControlSort[0];

  _.chartControlScale = [
    {
      id: 0,
      name: 'norm'
    },
    {
      id: 1,
      name: '100%'
    }
  ];
  _.selectedChartControlScale = _.chartControlScale[0];


  // TABLE
  _.gridOptions = {
    enableColumnMenus: false,
    columnDefs: [{ field: 'x', displayName: 'X' }, { field: 'y', displayName: 'Y' }],
  }
  _.showGrid = false;

  ////////////////////////////////////////////////////////////////////////////////////////

  var myTables = [
	{
		"data": [
			{"sales_or_users": "Yes, I have at least one digital user, but have not made any sales.", "instagram": "www.linkedin.com/abider", "public_funds": "0", "revenue": "5000", "twitter": "@abider", "LinkedIn": "abider", "pitch": "Nunc mauris elit, dictum eu, eleifend nec, malesuada ut, sem. Nulla interdum. Curabitur dictum. Phasellus in felis. Nulla tempor augue ac", "incorporation_date": "42296", "capital_from_competitions": "0", "looking_for": "Developers, Sales", "business_offering": "Both", "industries": "Marketing", "in_state_capital": "0", "First name": "Viola", "founder_email": "viola.pope@nova.college.edu", "Graduation year": "2007", "website": "www.abider.com", "School": "Nova College de Puerto Rico", "users": "380", "Last name": "Pope", "Gender": "M", "facebook": "www.facebook.com/abider", "vc_investment": "800000", "phase": "A new business", "out_of_state_capital": "0", "name": "neque. Sed eget", "business_type": "Non-Profit", "Major": "Health Care", "angel_investment": "40000", "success": "Getting to do something I love and am passionate about", "most_help": "Validation", "Status (current student, alumni, faculty, staff)": "Alumni", "created_at": "42069", "Email ": "viola.pope@nova.college.edu", "problem_solved": "metus vitae velit egestas lacinia. Sed congue, elit sed consequat auctor,", "College": "Nova College de Puerto Rico", "capital_from_school": "0", "incorporated": "false", "received_capital": "Yes", "total_capital": "840000", "Ethnicity": "Caucasian "}, {"sales_or_users": "Yes, I have at least one digital user, but have not made any sales.", "instagram": "www.linkedin.com/abidi", "public_funds": "0", "revenue": "3000", "twitter": "@abidi", "LinkedIn": "abidi", "pitch": "mattis velit justo nec ante. Maecenas mi felis, adipiscing fringilla, porttitor vulputate, posuere vulputate, lacus. Cras interdum. Nunc sollicitudin commodo ipsum. Suspendisse non leo. Vivamus nibh dolor, nonummy ac, feugiat non, lobortis quis, pede. Suspendisse dui. Fusce diam nunc, ullamcorper eu, euismod ac, fermentum vel, mauris. Integer", "incorporation_date": "41901", "capital_from_competitions": "0", "looking_for": "Sales, Investors", "business_offering": "Products", "industries": "Marketing", "in_state_capital": "0", "First name": "Denise", "founder_email": "denise.montgomery@huer.college.edu", "Graduation year": "2006", "website": "www.abidi.com", "School": "Huertas College", "users": "2690", "Last name": "Montgomery", "Gender": "F", "facebook": "www.facebook.com/abidi", "vc_investment": "0", "phase": "An idea", "out_of_state_capital": "0", "name": "Nulla tincidunt, neque", "business_type": "Profit", "Major": "Mathematics & Statistics", "angel_investment": "0", "success": "Getting to do something I love and am passionate about", "most_help": "Prototype/MVP", "Status (current student, alumni, faculty, staff)": "Faculty", "created_at": "41664", "Email ": "denise.montgomery@huer.college.edu", "problem_solved": "Suspendisse aliquet molestie tellus. Aenean egestas hendrerit neque. In ornare sagittis felis. Donec tempor, est", "College": "Huertas College", "capital_from_school": "0", "incorporated": "false", "received_capital": "No", "total_capital": "0", "Ethnicity": "Hispanic/Latino "}, {"sales_or_users": "Yes, I have BOTH at least one digital user and at least one sale.", "instagram": "www.linkedin.com/abiding", "public_funds": "0", "revenue": "8000", "twitter": "@abiding", "LinkedIn": "abiding", "pitch": "elit elit fermentum risus, at fringilla purus mauris a nunc. In at pede. Cras vulputate velit eu sem. Pellentesque ut ipsum ac mi eleifend egestas. Sed pharetra, felis eget varius ultrices, mauris ipsum porta elit, a feugiat tellus lorem", "incorporation_date": "41012", "capital_from_competitions": "0", "looking_for": "Developers, Sales", "business_offering": "Both", "industries": "Advertising", "in_state_capital": "0", "First name": "Lucille", "founder_email": "lucille.becker@ohio.college.edu", "Graduation year": "2013", "website": "www.abiding.com", "School": "Ohio University-Main Campus", "users": "750", "Last name": "Becker", "Gender": "M", "facebook": "www.facebook.com/abiding", "vc_investment": "0", "phase": "A new business", "out_of_state_capital": "0", "name": "a, enim. Suspendisse", "business_type": "Non-Profit", "Major": "Education", "angel_investment": "0", "success": "Monetary Wealth", "most_help": "Prototype/MVP", "Status (current student, alumni, faculty, staff)": "Alumni", "created_at": "40224", "Email ": "lucille.becker@ohio.college.edu", "problem_solved": "Morbi sit amet massa. Quisque porttitor eros nec tellus. Nunc lectus", "College": "Ohio University-Main Campus", "capital_from_school": "0", "incorporated": "false", "received_capital": "No", "total_capital": "0", "Ethnicity": "Caucasian "}, {"sales_or_users": "Yes, I have BOTH at least one digital user and at least one sale.", "instagram": "www.linkedin.com/abidingly", "public_funds": "0", "revenue": "7000", "twitter": "@abidingly", "LinkedIn": "abidingly", "pitch": "ligula. Nullam feugiat placerat velit. Quisque varius. Nam porttitor scelerisque neque. Nullam nisl. Maecenas malesuada fringilla est. Mauris eu turpis. Nulla aliquet. Proin velit. Sed malesuada augue ut lacus.", "incorporation_date": "40611", "capital_from_competitions": "0", "looking_for": "Developers", "business_offering": "Products", "industries": "Advertising", "in_state_capital": "0", "First name": "Dawn", "founder_email": "dawn.sandoval@nati.college.edu", "Graduation year": "2006", "website": "www.abidingly.com", "School": "National College of Natural Medicine", "users": "8670", "Last name": "Sandoval", "Gender": "F", "facebook": "www.facebook.com/abidingly", "vc_investment": "0", "phase": "An idea", "out_of_state_capital": "0", "name": "pretium neque. Morbi", "business_type": "Profit", "Major": "Military Science", "angel_investment": "0", "success": "Monetary Wealth", "most_help": "Prototype/MVP", "Status (current student, alumni, faculty, staff)": "Faculty", "created_at": "40340", "Email ": "dawn.sandoval@nati.college.edu", "problem_solved": "ut ipsum ac mi eleifend egestas. Sed pharetra, felis eget", "College": "National College of Natural Medicine", "capital_from_school": "0", "incorporated": "false", "received_capital": "No", "total_capital": "0", "Ethnicity": "Caucasian "}, {"sales_or_users": "Yes, I have BOTH at least one digital user and at least one sale.", "instagram": "www.linkedin.com/abidingness", "public_funds": "0", "revenue": "4000", "twitter": "@abidingness", "LinkedIn": "abidingness", "pitch": "dolor egestas rhoncus. Proin nisl sem, consequat nec, mollis vitae, posuere at, velit. Cras lorem lorem, luctus ut, pellentesque eget, dictum placerat, augue. Sed molestie. Sed id risus quis diam luctus lobortis. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos hymenaeos. Mauris ut", "incorporation_date": "42348", "capital_from_competitions": "0", "looking_for": "Developers", "business_offering": "Services", "industries": "Programming", "in_state_capital": "0", "First name": "Damon", "founder_email": "damon.mcdonald@lewi.college.edu", "Graduation year": "2012", "website": "www.abidingness.com", "School": "Lewis & Clark College", "users": "750", "Last name": "Mcdonald", "Gender": "M", "facebook": "www.facebook.com/abidingness", "vc_investment": "0", "phase": "A growing business", "out_of_state_capital": "0", "name": "elit. Etiam laoreet,", "business_type": "Non-Profit", "Major": "Psychology & Counseling", "angel_investment": "0", "success": "Getting to do something I love and am passionate about", "most_help": "Prototype/MVP", "Status (current student, alumni, faculty, staff)": "Current Student", "created_at": "40616", "Email ": "damon.mcdonald@lewi.college.edu", "problem_solved": "a, aliquet vel, vulputate eu, odio. Phasellus at augue id ante dictum cursus. Nunc mauris", "College": "Lewis & Clark College", "capital_from_school": "0", "incorporated": "false", "received_capital": "No", "total_capital": "0", "Ethnicity": "Native American/Alaskan "}, {"sales_or_users": "Yes, I have BOTH at least one digital user and at least one sale.", "instagram": "www.linkedin.com/Abie", "public_funds": "0", "revenue": "3000", "twitter": "@Abie", "LinkedIn": "Abie", "pitch": "nonummy ac, feugiat non, lobortis quis, pede. Suspendisse dui. Fusce diam nunc, ullamcorper eu, euismod ac, fermentum vel, mauris. Integer sem elit, pharetra ut, pharetra sed, hendrerit a, arcu. Sed et libero. Proin mi. Aliquam gravida mauris ut mi. Duis risus odio, auctor vitae, aliquet nec, imperdiet", "incorporation_date": "41566", "capital_from_competitions": "0", "looking_for": "Sales, Investors", "business_offering": "Services", "industries": "Advertising", "in_state_capital": "0", "First name": "Rene", "founder_email": "rene.carson@moun.college.edu", "Graduation year": "2010", "website": "www.Abie.com", "School": "Mount Angel Seminary", "users": "900", "Last name": "Carson", "Gender": "F", "facebook": "www.facebook.com/Abie", "vc_investment": "0", "phase": "A new business", "out_of_state_capital": "0", "name": "Nunc mauris sapien,", "business_type": "Profit", "Major": "Law", "angel_investment": "0", "success": "Getting to do something I love and am passionate about", "most_help": "Prototype/MVP", "Status (current student, alumni, faculty, staff)": "Current Student", "created_at": "41189", "Email ": "rene.carson@moun.college.edu", "problem_solved": "malesuada augue ut lacus. Nulla tincidunt, neque vitae semper egestas,", "College": "Mount Angel Seminary", "capital_from_school": "0", "incorporated": "false", "received_capital": "No", "total_capital": "0", "Ethnicity": "Caucasian "}, {"sales_or_users": "Yes, I have at least one digital user, but have not made any sales.", "instagram": "www.linkedin.com/Abies", "public_funds": "0", "revenue": "4000", "twitter": "@Abies", "LinkedIn": "Abies", "pitch": "Duis a mi fringilla mi lacinia mattis. Integer eu lacus. Quisque imperdiet, erat nonummy ultricies ornare, elit elit fermentum risus, at fringilla purus mauris a nunc. In at pede. Cras vulputate velit eu sem. Pellentesque ut ipsum ac mi eleifend egestas. Sed", "incorporation_date": "42327", "capital_from_competitions": "0", "looking_for": "Developers, Sales, Investors", "business_offering": "Services", "industries": "Advertising", "in_state_capital": "0", "First name": "Johnny", "founder_email": "johnny.phelps@comm.college.edu", "Graduation year": "2005", "website": "www.Abies.com", "School": "Community College of Vermont", "users": "8080", "Last name": "Phelps", "Gender": "F", "facebook": "www.facebook.com/Abies", "vc_investment": "0", "phase": "A growing business", "out_of_state_capital": "0", "name": "sem, vitae aliquam", "business_type": "Profit", "Major": "Communications", "angel_investment": "0", "success": "Getting to do something I love and am passionate about", "most_help": "Validation", "Status (current student, alumni, faculty, staff)": "Current Student", "created_at": "40832", "Email ": "johnny.phelps@comm.college.edu", "problem_solved": "nisl. Nulla eu neque pellentesque massa lobortis ultrices. Vivamus rhoncus. Donec est. Nunc ullamcorper, velit", "College": "Community College of Vermont", "capital_from_school": "0", "incorporated": "false", "received_capital": "No", "total_capital": "0", "Ethnicity": "Caucasian "}, {"sales_or_users": "Yes, I have BOTH at least one digital user and at least one sale.", "instagram": "www.linkedin.com/abietate", "public_funds": "0", "revenue": "0", "twitter": "@abietate", "LinkedIn": "abietate", "pitch": "et magnis dis parturient montes, nascetur ridiculus mus. Proin vel nisl. Quisque fringilla euismod enim. Etiam gravida molestie arcu. Sed eu nibh vulputate mauris sagittis placerat. Cras dictum ultricies", "incorporation_date": "42165", "capital_from_competitions": "0", "looking_for": "Developers", "business_offering": "Both", "industries": "Advertising", "in_state_capital": "0", "First name": "Melba", "founder_email": "melba.hayes@corn.college.edu", "Graduation year": "2006", "website": "www.abietate.com", "School": "Corning Community College", "users": "8800", "Last name": "Hayes", "Gender": "M", "facebook": "www.facebook.com/abietate", "vc_investment": "1100000", "phase": "A new business", "out_of_state_capital": "0", "name": "a felis ullamcorper", "business_type": "Non-Profit", "Major": "Languages and Literature", "angel_investment": "60000", "success": "Monetary Wealth", "most_help": "Prototype/MVP", "Status (current student, alumni, faculty, staff)": "Current Student", "created_at": "41443", "Email ": "melba.hayes@corn.college.edu", "problem_solved": "ligula elit, pretium et, rutrum non, hendrerit id, ante. Nunc mauris sapien, cursus in,", "College": "Corning Community College", "capital_from_school": "0", "incorporated": "true", "received_capital": "Yes", "total_capital": "1160000", "Ethnicity": "Caucasian "}, {"sales_or_users": "Yes, I have BOTH at least one digital user and at least one sale.", "instagram": "www.linkedin.com/abietene", "public_funds": "0", "revenue": "9000", "twitter": "@abietene", "LinkedIn": "abietene", "pitch": "a tortor. Nunc commodo auctor velit. Aliquam nisl. Nulla eu neque pellentesque massa lobortis ultrices. Vivamus rhoncus. Donec est. Nunc ullamcorper, velit in aliquet lobortis, nisi nibh lacinia orci, consectetuer euismod est arcu ac orci.", "incorporation_date": "42103", "capital_from_competitions": "0", "looking_for": "Developers, Sales", "business_offering": "Both", "industries": "Programming", "in_state_capital": "0", "First name": "Gene", "founder_email": "gene.young@spri.college.edu", "Graduation year": "2012", "website": "www.abietene.com", "School": "Springfield Technical Community College", "users": "320", "Last name": "Young", "Gender": "M", "facebook": "www.facebook.com/abietene", "vc_investment": "0", "phase": "A new business", "out_of_state_capital": "0", "name": "suscipit, est ac", "business_type": "Non-Profit", "Major": "Mechanics and Repair", "angel_investment": "0", "success": "Monetary Wealth", "most_help": "Prototype/MVP", "Status (current student, alumni, faculty, staff)": "Faculty", "created_at": "40534", "Email ": "gene.young@spri.college.edu", "problem_solved": "Mauris nulla. Integer urna. Vivamus molestie dapibus ligula. Aliquam erat volutpat. Nulla dignissim. Maecenas", "College": "Springfield Technical Community College", "capital_from_school": "0", "incorporated": "false", "received_capital": "No", "total_capital": "0", "Ethnicity": "Native American/Alaskan "}
			],
		"id": 19,
		"columns": [{"type": "string", "name": "College"}, {"type": "string", "name": "Email "}, {"type": "string", "name": "Ethnicity"}, {"type": "string", "name": "First name"}, {"type": "string", "name": "Gender"}, {"type": "number", "name": "Graduation year"}, {"type": "string", "name": "Last name"}, {"type": "string", "name": "LinkedIn"}, {"type": "string", "name": "Major"}, {"type": "string", "name": "School"}, {"type": "string", "name": "Status (current student, alumni, faculty, staff)"}, {"type": "number", "name": "angel_investment"}, {"type": "string", "name": "business_offering"}, {"type": "string", "name": "business_type"}, {"type": "number", "name": "capital_from_competitions"}, {"type": "number", "name": "capital_from_school"}, {"type": "number", "name": "created_at"}, {"type": "string", "name": "facebook"}, {"type": "string", "name": "founder_email"}, {"type": "number", "name": "in_state_capital"}, {"type": "string", "name": "incorporated"}, {"type": "number", "name": "incorporation_date"}, {"type": "string", "name": "industries"}, {"type": "string", "name": "instagram"}, {"type": "string", "name": "looking_for"}, {"type": "string", "name": "most_help"}, {"type": "string", "name": "name"}, {"type": "number", "name": "out_of_state_capital"}, {"type": "string", "name": "phase"}, {"type": "string", "name": "pitch"}, {"type": "string", "name": "problem_solved"}, {"type": "number", "name": "public_funds"}, {"type": "string", "name": "received_capital"}, {"type": "number", "name": "revenue"}, {"type": "string", "name": "sales_or_users"}, {"type": "string", "name": "success"}, {"type": "number", "name": "total_capital"}, {"type": "string", "name": "twitter"}, {"type": "number", "name": "users"}, {"type": "number", "name": "vc_investment"}, {"type": "string", "name": "website"}],
		"name": "my table"
	}
];

    myTables.forEach(function(table){
      _.tables.push(table);
    });


  ///////////////////////////////////////////////////////////////////////////////////////

  // UTILS
  _.loadData = loadData;

  _.click = click;

  _.getFieldTypes = getFieldTypes;

  // WATCH
  $scope.$watch('_.selectedTable', onSelectedTable);

  $scope.$watch('_.selectedView', onSelectedView);

  $scope.$watch('_.selectedDataField', onSelectedDataField);

  $scope.$watch('_.selectedChartControlSort', onSelectedChartControlSort);

  $scope.$watch('_.selectedChartControlScale', onSelectedChartControlScale);

  // WINDOW
  window.addEventListener('resize', function(e){
    for (var item in _.charts) if (_.charts[item]) _.charts[item].render();
  });

  // UTILS DEFINITION

  function click(type, $event){
    var node = $event.target.parentNode;
    node.style.display = 'none';
    $timeout(function(){
      node.style.display = null;
    }, 300);

    var ce, ct;

    if (_.charts.barChart && _.charts.barChart.export) {
      ct = _.charts.barChart.type;
      ce = _.charts.barChart.export;
    } else {
      return;
    }

    if (type == 'png') {
      ce.toPNG({}, function( data ) {
        ce.download( data, "image/png", "chart.png" );
      });
    }
    else if (type == 'pdf') {
      ce.toPDF({}, function( data ) {
        ce.download( data, "application/pdf", "chart.pdf" );
      });
    }
    else if (type == 'csv') {
      ce.toCSV({ updateData: updateData(ct) }, function( data ) {
        ce.download( data, "text/plain", "chart.csv" );
      });
    }
    else if (type == 'json') {
      ce.toJSON({ updateData: updateData(ct) }, function( data ) {
        ce.download( data, "text/plain", "chart.json" );
      });
    }

  }

  function updateData(type){
    return function(_data){
      var data = [];
      _data.forEach(function(d){
        var item = {};

        if (type == 'bar') {
          item[_.selectedDataField] = d.x;
          item['Count, %'] = d.y;
          item['count'] = d.count;
        }
        else if (type == 'horizontalBar') {
          item[_.selectedDataField] = d.y;
          item['Count, %'] = d.x;
          item['count'] = d.count;
        }

        data.push(item);
      });

      return data;
    }
  }

  function getFieldTypes(){
    return Object.keys(_.dataFieldsByType);
  }

  function loadData(cb){

    // Check if table has already data, or load data from somewhere
    if (!_.selectedTable.url) {

      _.data = _.selectedTable.data;

      if (_.data.length) {
        _.dataFieldsByType.string.fields = [];
        _.dataFieldsByType.numeric.fields = [];
        _.dataFieldsByType.date.fields = [];
        _.dataFields = [];

        _.dataFields = _.selectedTable.columns.map(function(c){ return c.name; });

        _.selectedTable.columns.forEach(function(c){
          _.dataFields.push(c.name);

          if (c.type === 'string') {
            _.dataFieldsByType.string.fields.push(c.name);
          }
          if (c.type === 'number') {
            _.dataFieldsByType.numeric.fields.push(c.name);
          }
          if (c.type === 'date') {
            _.dataFieldsByType.date.fields.push(c.name);
          }
        })
      }

      _.selectedDataField = null;

    } else {

      d3[_.selectedTable.type](_.selectedTable.url, function(error, data){
        if (error) throw error;

        _.data = data;

        if (data.length) {
          _.dataFieldsByType.string.fields = [];
          _.dataFieldsByType.numeric.fields = [];
          _.dataFieldsByType.date.fields = [];

          _.dataFields = Object.keys(data[0]);
          _.dataFields.shift();

          _.dataFields.forEach(function(f){
            if (!isNaN(+data[0][f]))
              _.dataFieldsByType.numeric.fields.push(f);
            else
              _.dataFieldsByType.string.fields.push(f);
          })
        }

        _.selectedDataField = null;

        if (typeof cb === 'function') cb();
      });

    }
  }


  // WATCHERS

  function onSelectedTable(){
    _.loadData(function(){
      onSelectedView(_.selectedView);
      $scope.$digest();
    });
  }

  function onSelectedView(v){
    // hide grid
    _.showGrid = false;

    // clear chart
    if (_.charts.barChart && _.charts.barChart.clear) {
      _.charts.barChart.clear();
      _.charts.barChart = null;
    }

    if (v.id == 1 && _.selectedDataField) {
      $timeout(function(){
        onSelectedDataField(_.selectedDataField);
      }, 20);
    }
  }

  function onSelectedDataField(f){
    if (!f) return;

    var chartOptions = {
      order: _.selectedChartControlSort.id,
      scale: _.selectedChartControlScale.id
    };

    // try to find type from data or calculate automatically
    if (_.selectedTable.columns) {

      var col = _.selectedTable.columns.filter(function(d){ return d.name === f })[0];

      if (col.type === 'number') {
        _.chartData = getHistogram(f, 8);
        _.charts.barChart = barChart(_.chartData, '#chart', chartOptions).fadeRender();
        _.gridOptions.data = _.chartData;
        _.gridOptions.columnDefs = [
          { field: 'x', displayName: f },
          { field: 'y', displayName: 'Count, %' },
          { field: 'count', displayName: 'Count' }
        ];
      }
      else if (col.type === 'string') {
        _.chartData = getFrequency(f);
        _.charts.barChart = horizontalBarChart(_.chartData, '#chart', chartOptions).fadeRender();
        _.gridOptions.data = _.chartData;
        _.gridOptions.columnDefs = [
          { field: 'y', displayName: f },
          { field: 'x', displayName: 'Count, %' },
          { field: 'count', displayName: 'Count' }
        ]
      }
      else if (col.type === 'date') {
        _.chartData = getDateHistogram(f, col.date_format, 8);
        _.charts.barChart = barChart(_.chartData, '#chart', chartOptions).fadeRender();
        _.gridOptions.data = _.chartData;
        _.gridOptions.columnDefs = [
          { field: 'x', displayName: f },
          { field: 'y', displayName: 'Count, %' },
          { field: 'count', displayName: 'Count' }
        ];
      }

    } else {

      var value = _.data[0][f];

      if (!isNaN(value)) {
        _.chartData = getHistogram(f, 8);
        _.charts.barChart = barChart(_.chartData, '#chart', chartOptions).fadeRender();
        _.gridOptions.data = _.chartData;
        _.gridOptions.columnDefs = [
          { field: 'x', displayName: f },
          { field: 'y', displayName: 'Count, %' },
          { field: 'count', displayName: 'Count' }
        ];
      } else {
        _.chartData = getFrequency(f);
        _.charts.barChart = horizontalBarChart(_.chartData, '#chart', chartOptions).fadeRender();
        _.gridOptions.data = _.chartData;
        _.gridOptions.columnDefs = [
          { field: 'y', displayName: f },
          { field: 'x', displayName: 'Count, %' },
          { field: 'count', displayName: 'Count' }
        ]
      }

    }

    // ADD EXPORT FOR CHART
    if (ChartExport) _.charts.barChart.export = new ChartExport.export(_.charts.barChart, {});

    // show grid
    _.showGrid = true;
  }

  function onSelectedChartControlSort(s){
    if (!s) return;

    if (_.charts.barChart) {
      _.charts.barChart.order(s.id).redraw();
    }
  }

  function onSelectedChartControlScale(s){
    if (!s) return;

    if (_.charts.barChart) {
      _.charts.barChart.scale(s.id).redraw();
    }
  }

  // CALCULATE DATA
  function getHistogram(f, N){
    var res;
    var L = _.data.length;
    var range = d3.extent(_.data, function(d){ return +d[f]; });

    N = calculateN(f, N, range, function(d){ return +d; });

    var data = [];
    for (var i = 0; i < N; i++) data.push([]);

    if (range[0] == range[1]) {

      _.data.forEach(function(d){
        data[0].push(+d[f]);
      });

      res = [{
        x: prettyNum(range[0]) + ' to ' + prettyNum(range[0]),
        y: 100,
        count: data[0].length
      }];

    } else {

      var step = (range[1] - range[0])/N;
      _.data.forEach(function(d){
        var v = +d[f];
        var idx = Math.trunc((v - range[0]) / step);
        if (idx == N) idx = N - 1;
        data[idx].push(v);
      });

      res = data.map(function(d, i){
        return {
          x: prettyNum(range[0] + i * step) + ' to ' + prettyNum(range[0] + (i + 1) * step),
          y: 100 * d.length / L,
          count: d.length
        };
      });

    }

    return res;
  }

  function getFrequency(f){
    var data = {};

    _.data.forEach(function(d){
      var v = d[f];
      if (!data[v]) data[v] = 0;
      data[v]++;
    });

    var L = _.data.length;

    return Object.keys(data).map(function(v){
      return {
        x: 100 * data[v] / L,
        y: v,
        count: data[v]
      }
    });
  }

  function getDateHistogram(f, format, N){
    var res;
    var fmt = d3.time.format(format);

    var L = _.data.length;
    var range = d3.extent(_.data, function(d){ return fmt.parse(d[f]); });

    N = calculateN(f, N, range, fmt.parse);

    var data = [];
    for (var i = 0; i < N; i++) data.push([]);

    if (range[0] == range[1]) {

      _.data.forEach(function(d){
        data[0].push(fmt.parse(d[f]));
      });

      res = [{
        x: fmt(range[0]) + ' to ' + fmt(range[0]),
        y: 100,
        count: data[0].length
      }];

    } else {

      var step = (range[1] - range[0])/N;

      _.data.forEach(function(d){
        var v = fmt.parse(d[f]);
        var idx = Math.trunc((v - range[0]) / step);
        if (idx == N) idx = N - 1;
        data[idx].push(v);
      });

      res = data.map(function(d, i){
        return {
          x: fmt(new Date(Math.round(+range[0] + i * step))) + ' to ' + fmt(new Date(Math.round(+range[0] + (i + 1) * step))),
          y: 100 * d.length / L,
          count: d.length
        };
      });

    }

    return res;
  }

  function calculateN(f, N, range, format){
    if (N == 1) return N;

    var L = _.data.length;
    var bulkCounts = 0;
    var data = {};

    var step = (range[1] - range[0])/N;
    var i = 0;
    while (i < L && bulkCounts < N) {
      var d = _.data[i];
      var v = format(d[f]);
      var idx = Math.trunc((v - range[0]) / step);
      if (idx == N) idx = N - 1;
      if (!data[idx]){
        data[idx] = true;
        bulkCounts++;
      };
      i++;
    }

    return bulkCounts == N ? N : calculateN(f, N - 1, range, format);
  }

  function prettyNum(n){
    return parseFloat(n.toFixed(2));
  }
}/**
 * Bar Chart Definition
 */
;function barChart(_data, selector, options){
  options = options || {};
  var data = _data.slice();

  var chart
    , fullWidth
    , fullHeight
    , margin
    , width
    , height
    , x
    , y
    , xAccessor = options.xAccessor || function(d) { return d.x }
    , yAccessor = options.yAccessor || function(d) { return d.y }
    , xAxis
    , yAxis
    , svg
    , bars
    , barLabels
    , xAxisG
    , yAxisG
    , tooltip
    , duration = 500
    , order = options.order || 0
    , scale = options.scale || 0
    ;

  // render the chart completely
  function render(){

    // clear
    clear();

    // set width
    fullWidth = options.fullWidth || $(selector).width() || 300;
    fullHeight = options.fullHeight || $(selector).height() - 30 || 300;

    margin = {top: 20, right: 10, bottom: 30, left: 30};
    width = fullWidth - margin.left - margin.right;
    height = fullHeight - margin.top - margin.bottom;

    x = d3.scale.ordinal()
      .rangeRoundBands([0, width], 0.1);

    y = d3.scale.linear()
      .range([height, 0])
      .nice();

    xAxis = d3.svg.axis()
      .scale(x)
      .orient('bottom')
      .tickSize(4)

    yAxis = d3.svg.axis()
      .scale(y)
      .orient('left')
      .tickSize(4);

    // Create svg
    svg = d3.select(selector).append('svg')
      .attr('width', fullWidth)
      .attr('height', fullHeight)
      .style({
        'position': 'relative'
      })
      .append('g')
      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    if (!data || !data.length) {
      svg.append('text')
        .attr('transform', 'translate(' + width/2 + ',' + height/2 + ')')
        .style({
          'text-anchor': 'middle'
        })
        .html('No Data');

      return chart;
    }

    // sort data
    data.sort(ordering(order));

    x.domain(data.map(function(d, i) { return xAccessor(d, i); }));
    y.domain([0, scale ? 100 : 1.1 * d3.max(data, function(d, i) { return yAccessor(d, i); })]);

    // Draw the y Grid lines
    svg.append('g')
      .attr('class', 'grid')
      .style({
        'stroke': 'lightgrey',
        'stroke-opacity': 0.7,
        'shape-rendering': 'crispEdges'
      })
      .call(d3.svg.axis()
        .scale(y)
        .orient('left')
        .tickSize(-width, 0, 0)
        .tickFormat('')
      );

    // Draw stacked bars
    bars = svg.selectAll('.bar')
      .data(data);

    bars.enter().append('rect')
      .attr('class', 'bar')
      .attr('x', function(d, i) { return x(xAccessor(d, i)); })
      .attr('width', x.rangeBand())
      .attr('y', function(d, i) { return y(yAccessor(d, i)); })
      .attr('height', function(d, i) { return height - y(yAccessor(d, i)); })
      .style({
        'fill': 'steelblue',
        'shape-rendering': 'crispEdges'
      })
      .on('mouseover', mouseover)
      .on('mouseout', mouseout)
      .on('mousemove', mousemove);

    bars.exit().remove();

    // bar labels
    barLabels = svg.selectAll('.bar-label')
      .data(data);

    barLabels.enter().append('text')
      .attr('class', 'bar-label')
      .attr("text-anchor", "middle")
      .style("fill", function(d, i){ return height - y(yAccessor(d, i)) < 18 ? '#000' : "#fff"; })
      .style({
        'font': '13px sans-serif'
      })
      .attr("x", function(d, i) { return x(xAccessor(d, i)) + x.rangeBand() / 2; })
      .attr("y", function(d, i) { return y(yAccessor(d, i)) + (height - y(yAccessor(d, i)) < 18 ? -2 : 13); })
      .text(function(d){ return d.y + '%'; });

    barLabels.exit().remove();

    // X Axis
    xAxisG = svg.append('g')
      .attr('class', 'x axis')
      .attr('transform', 'translate(0,' + height + ')')
      .style({
        'font': '12px sans-serif'
      })
      .call(xAxis)

    xAxisG.selectAll('path')
      .style({
        'display': 'none'
      });

    xAxisG.selectAll('line')
      .style({
        'fill': 'none',
        'stroke': '#000',
        'shape-rendering': 'crispEdges'
      });

    // Y Axis
    yAxisG = svg.append('g')
      .attr('class', 'y axis')
      .attr('transform', 'translate(' + 0 + ',0)')
      .style({
        'font': '12px sans-serif'
      })
      .call(yAxis);

    yAxisG.selectAll('path')
      .style({
        'fill': 'none',
        'stroke': '#000',
        'shape-rendering': 'crispEdges'
      });

    yAxisG.selectAll('line')
      .style({
        'fill': 'none',
        'stroke': '#000',
        'shape-rendering': 'crispEdges'
      });

    // Tooltip
    tooltip = d3.select(selector).append('div')
      .attr('class', 'tip')
      .style('display', 'none');

    // export module
    chart.divRealWidth = fullWidth;
    chart.divRealHeight = fullHeight;
    chart.div = d3.select(selector).node();
    chart.svg = svg;

    return chart;
  }

  // redraw the chart with new data
  function redraw(){
    if (!data || !data.length || !svg.selectAll('.bar')[0].length) return render();

    // sort data
    data.sort(ordering(order));

    x.domain(data.map(function(d, i) { return xAccessor(d, i); }));
    y.domain([0, scale ? 100 : 1.1 * d3.max(data, function(d, i) { return yAccessor(d, i); })]);

    // Draw the y Grid lines
    svg.selectAll('.grid')
      .transition()
      .duration(duration)
      .call(d3.svg.axis()
        .scale(y)
        .orient('left')
        .tickSize(-width, 0, 0)
        .tickFormat('')
      );

    // bars
    bars = svg.selectAll('.bar')
      .data(data);

    bars
      .transition()
      .duration(duration)
      .attr('x', function(d, i) { return x(xAccessor(d, i)); })
      .attr('width', x.rangeBand())
      .attr('y', function(d, i) { return y(Math.max(0, yAccessor(d, i))); })
      .attr('height', function(d, i) { return Math.abs(y(yAccessor(d, i)) - y(0)); })

    bars.style({
        'fill': 'steelblue'
      })
      .on('mouseover', mouseover)
      .on('mouseout', mouseout)
      .on('mousemove', mousemove);

    bars.exit()
      .transition()
      .duration(duration)
      .attr('height', 0)
      .attr('y', y(0))
      .remove();

    // bar labels
    barLabels = svg.selectAll('.bar-label')
      .data(data);

    barLabels
      .transition()
      .duration(duration)
      .style("fill", function(d, i){ return height - y(yAccessor(d, i)) < 18 ? '#000' : "#fff"; })
      .attr("x", function(d, i) { return x(xAccessor(d, i)) + x.rangeBand() / 2; })
      .attr("y", function(d, i) { return y(yAccessor(d, i)) + (height - y(yAccessor(d, i)) < 18 ? -2 : 13); })
      .text(function(d){ return d.y + '%'; });

    barLabels.exit()
      .transition()
      .duration(duration)
      .attr('y', y(0))
      .remove();

    xAxisG.transition().duration(duration).call(xAxis);
    yAxisG.transition().duration(duration).call(yAxis);

    return chart;
  }

  // update with new data
  function updateData(_data){
    data = _data.slice();
  }

  // fade render
  function fadeRender(){
    var duration = 200;

    d3.select(selector)
      .style('opacity', 1)
      .transition()
      .duration(duration)
      .style('opacity', 0)
      .each('end', function(){
        render();

        d3.select(selector)
          .style('opacity', 0)
          .transition()
          .duration(duration)
          .style('opacity', 1);
      });

    return chart;
  }

  // clearing
  function clear(){
    //clear element
    d3.select(selector).html('');

    // remove tooltip
    d3.select(selector).selectAll('.tip').remove();
  }

  // ordering
  function ordering(order){
    switch (order) {
      // desc
      case 0: return function(a, b){ return yAccessor(b) - yAccessor(a); };

      // asc
      case 1: return function(a, b){ return yAccessor(a) - yAccessor(b); };

      // abc
      case 2: return function(a, b){ return yAccessor(b) - yAccessor(a); };
    }
  }

  // Utils
  function mouseover(d, i){
    d3.select(this)
      .style({
        'fill': 'brown'
      });

    tooltip.style('display', null);
  }

  function mouseout(d, i){
    d3.select(this)
      .style({
        'fill': 'steelblue'
      });

    tooltip.style('display', 'none');
  }

  function mousemove(d, i){
    var tpl =
      '<ul>' +
      '<li><b>' + xAccessor(d, i) + '</b></li>' +
      '<li>Count: ' + d.count +'</li>' +
      '<li>' + yAccessor(d, i) +'%</li>' +
      '</ul>';

    tooltip.html(tpl);

    var xPosition = d3.event.layerX - 40;
    var yPosition = d3.event.layerY - 30;

    tooltip.style('top', yPosition + 'px');
    tooltip.style('left', xPosition + 'px');
  }

  // main object
  chart = {
    selector: selector,
    type: 'bar',
    data: data,
    classNamePrefix: 'chart-export',
    x: function(){ return x; },
    y: function(){ return y; },
    render: render,
    redraw: redraw,
    updateData: updateData,
    fadeRender: fadeRender,
    clear: clear
  };

  chart.order = function(_){
    if (!arguments.length) return order;
    order = _;
    return chart;
  }

  chart.scale = function(_){
    if (!arguments.length) return scale;
    scale = _;
    return chart;
  }

  return chart;
}/**
 * Horizontal Bar Chart Definition
 */
;function horizontalBarChart(_data, selector, options){
  options = options || {};
  var data = _data.slice();

  var chart
    , fullWidth
    , fullHeight
    , margin
    , width
    , height
    , x
    , y
    , xAccessor = options.xAccessor || function(d) { return d.x }
    , yAccessor = options.yAccessor || function(d) { return d.y }
    , xAxis
    , yAxis
    , svg
    , bars
    , barLabels
    , xAxisG
    , yAxisG
    , tooltip
    , duration = 500
    , order = options.order || 0
    , scale = options.scale || 0
  ;

  // render the chart completely
  function render(){

    // clear
    clear();

    // set width
    fullWidth = options.fullWidth || $(selector).width() || 300;
    fullHeight = options.fullHeight || $(selector).height() - 30 || 300;

    margin = {top: 20, right: 10, bottom: 30, left: 80};
    if (data && data.length) {
      margin.left = d3.max(data.map(function(d, i){ return yAccessor(d, i).length * 6 + 15; }));
    }

    width = fullWidth - margin.left - margin.right;
    height = fullHeight - margin.top - margin.bottom;

    y = d3.scale.ordinal()
      .rangeRoundBands([height, 0], 0.1);

    x = d3.scale.linear()
      .range([0, width])
      .nice();

    xAxis = d3.svg.axis()
      .scale(x)
      .orient('bottom')
      .tickSize(4)

    yAxis = d3.svg.axis()
      .scale(y)
      .orient('left')
      .tickSize(4);


    // Create svg
    svg = d3.select(selector).append('svg')
      .attr('width', fullWidth)
      .attr('height', fullHeight)
      .style({
        'position': 'relative'
      })
      .append('g')
      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    if (!data || !data.length) {
      svg
        .attr('transform', 'translate(0,0)')
        .append('text')
        .attr('transform', 'translate(' + fullWidth/2 + ',' + fullHeight/2 + ')')
        .style({
          'text-anchor': 'middle'
        })
        .html('No Data');

      return chart;
    }

    if (data.length > 10) {
      svg
        .attr('transform', 'translate(0,0)')
        .append('text')
        .attr('transform', 'translate(' + fullWidth/2 + ',' + fullHeight/2 + ')')
        .style({
          'text-anchor': 'middle'
        })
        .html('Too Many Values');

      return chart;
    }

    // sort data
    data.sort(ordering(order));

    x.domain([0, scale ? 100 : 1.1 * d3.max(data, function(d, i) { return xAccessor(d, i); })]);
    y.domain(data.map(function(d, i) { return yAccessor(d, i); }));

    // Draw the y Grid lines
    svg.append('g')
      .attr('class', 'grid')
      .style({
        'stroke': 'lightgrey',
        'stroke-opacity': 0.7,
        'shape-rendering': 'crispEdges'
      })
      .call(d3.svg.axis()
        .scale(x)
        .orient('bottom')
        .tickSize(height, 0, 0)
        .tickFormat('')
      );

    // Draw stacked bars
    bars = svg.selectAll('.bar')
      .data(data);

    bars.enter().append('rect')
      .attr('class', 'bar')
      .attr('width', function(d, i) { return x(xAccessor(d, i)); })
      .attr('y', function(d, i) { return y(yAccessor(d, i)); })
      .attr('height', y.rangeBand())
      .style({
        'fill': 'steelblue',
        'shape-rendering': 'crispEdges'
      })
      .on('mouseover', mouseover)
      .on('mouseout', mouseout)
      .on('mousemove', mousemove);

    bars.exit().remove();

    // bar labels
    barLabels = svg.selectAll('.bar-label')
      .data(data);

    barLabels.enter().append('text')
      .attr('class', 'bar-label')
      .attr("text-anchor", "end")
      .style("fill", function(d, i){ return x(xAccessor(d, i)) < 30 ? '#000' : "#fff"; })
      .style({
        'font': '13px sans-serif'
      })
      .attr("x", function(d, i) { return x(xAccessor(d, i)) + (x(xAccessor(d, i)) < 30 ? 32 : -4); })
      .attr("y", function(d, i) { return y(yAccessor(d, i)) + y.rangeBand() / 2 + 4; })
      .text(function(d){ return d.x + '%'; });

    barLabels.exit().remove();


    // X Axis
    xAxisG = svg.append('g')
      .attr('class', 'x axis')
      .attr('transform', 'translate(0,' + height + ')')
      .style({
        'font': '12px sans-serif'
      })
      .call(xAxis)

    xAxisG.selectAll('path')
      .style({
        'fill': 'none',
        'stroke': '#000',
        'shape-rendering': 'crispEdges'
      });

    xAxisG.selectAll('line')
      .style({
        'fill': 'none',
        'stroke': '#000',
        'shape-rendering': 'crispEdges'
      });

    // Y Axis
    yAxisG = svg.append('g')
      .attr('class', 'y axis')
      .attr('transform', 'translate(' + 0 + ',0)')
      .style({
        'font': '12px sans-serif'
      })
      .call(yAxis);

    yAxisG.selectAll('path')
      .style({
        'fill': 'none',
        'stroke': '#000',
        'shape-rendering': 'crispEdges'
      });

    yAxisG.selectAll('line')
      .style({
        'fill': 'none',
        'stroke': '#000',
        'shape-rendering': 'crispEdges'
      });

    // Tooltip
    tooltip = d3.select(selector).append('div')
      .attr('class', 'tip')
      .style('display', 'none');

    // export module
    chart.divRealWidth = fullWidth;
    chart.divRealHeight = fullHeight;
    chart.div = d3.select(selector).node();
    chart.svg = svg;

    return chart;
  }

  // redraw the chart with new data
  function redraw(){
    if (!data || !data.length || !svg.selectAll('.bar')[0].length) return render();

    // sort data
    data.sort(ordering(order));

    x.domain([0, scale ? 100 : 1.1 * d3.max(data, function(d, i) { return xAccessor(d, i); })]);
    y.domain(data.map(function(d, i) { return yAccessor(d, i); }));

    // Draw the y Grid lines
    svg.selectAll('.grid')
      .transition()
      .duration(duration)
      .call(d3.svg.axis()
        .scale(x)
        .orient('bottom')
        .tickSize(height, 0, 0)
        .tickFormat('')
      );

    bars = svg.selectAll('.bar')
      .data(data)

    bars
      .transition()
      .duration(duration)
      .attr('width', function(d, i) { return x(xAccessor(d, i)); })
      .attr('y', function(d, i) { return y(yAccessor(d, i)); })
      .attr('height', y.rangeBand())

    bars.style({
        'fill': 'steelblue'
      })
      .on('mouseover', mouseover)
      .on('mouseout', mouseout)
      .on('mousemove', mousemove);

    bars.exit()
      .transition()
      .duration(duration)
      .attr('width', 0)
      .remove();

    // bar labels
    barLabels = svg.selectAll('.bar-label')
      .data(data)

    barLabels.transition()
      .duration(duration)
      .attr("x", function(d, i) { return x(xAccessor(d, i)) + (x(xAccessor(d, i)) < 30 ? 32 : -4); })
      .attr("y", function(d, i) { return y(yAccessor(d, i)) + y.rangeBand() / 2 + 4; })
      .style("fill", function(d, i){ return x(xAccessor(d, i)) < 30 ? '#000' : "#fff"; })
      .text(function(d){ return d.x + '%'; });

    barLabels.exit()
      .transition()
      .duration(duration)
      .attr('x', 0)
      .remove();

    xAxisG.transition().duration(duration).call(xAxis);
    yAxisG.transition().duration(duration).call(yAxis);

    return chart;
  }

  // update with new data
  function updateData(_data){
    data = _data.slice();
  }

  // fade render
  function fadeRender(){
    var duration = 200;

    d3.select(selector)
      .style('opacity', 1)
      .transition()
      .duration(duration)
      .style('opacity', 0)
      .each('end', function(){
        render();

        d3.select(selector)
          .style('opacity', 0)
          .transition()
          .duration(duration)
          .style('opacity', 1);
      });

    return chart;
  }

  // clearing
  function clear(){
    //clear element
    d3.select(selector).html('');

    // remove tooltip
    d3.select(selector).selectAll('.tip').remove();
  }

  // ordering
  function ordering(order){
    switch (order) {
      // desc
      case 0: return function(a, b){ return xAccessor(a) - xAccessor(b); };

      // asc
      case 1: return function(a, b){ return xAccessor(b) - xAccessor(a); };

      // abc
      case 2: return function(a, b){ return yAccessor(b) > yAccessor(a); };
    }
  }

  // Utils
  function mouseover(d, i){
    d3.select(this)
      .style({
        'fill': 'brown'
      });

    tooltip.style('display', null);
  }

  function mouseout(d, i){
    d3.select(this)
      .style({
        'fill': 'steelblue'
      });

    tooltip.style('display', 'none');
  }

  function mousemove(d, i){
    var tpl =
      '<ul>' +
      '<li><b>' + yAccessor(d, i) + '</b></li>' +
      '<li>Count: ' + d.count +'</li>' +
      '<li>' + xAccessor(d, i) +'%</li>' +
      '</ul>';

    tooltip.html(tpl);

    var xPosition = d3.event.layerX - 35;
    var yPosition = d3.event.layerY - 30;

    tooltip.style('top', yPosition + 'px');
    tooltip.style('left', xPosition + 'px');
  }

  // main object
  chart = {
    selector: selector,
    type: 'horizontalBar',
    data: data,
    classNamePrefix: 'chart-export',
    x: function(){ return x; },
    y: function(){ return y; },
    render: render,
    redraw: redraw,
    updateData: updateData,
    fadeRender: fadeRender,
    clear: clear
  };

  chart.order = function(_){
    if (!arguments.length) return order;
    order = _;
    return chart;
  }

  chart.scale = function(_){
    if (!arguments.length) return scale;
    scale = _;
    return chart;
  }

  return chart;
}
  </script>

</head>

<body ng-controller="dashCtrl as _" ng-cloak class="no-user-select">

  <div class="dashboard">

    <div class="row">
      <div class="col col-md-12">
        <div class="section section-top-table">

          <div class="title">Select Data Set</div>

          <div class="row">
            <div class="col col-md-12">
              <div class="btn btn-default btn-lg" ng-repeat="t in _.tables track by t.id"
                   ng-class="{ active: t.id == _.selectedTable.id }"
                   ng-click="_.selectedTable = t"
              ><div>{{ t.name }}</div><div class="count">{{t.data.length}}</div></div>
              <!--<select-->
                  <!--name="tableSelect"-->
                  <!--ng-model="_.selectedTable"-->
                  <!--ng-options="option.name for option in _.tables track by option.id"-->
              <!--&gt;</select>-->
            </div>
          </div>

        </div>
        <div class="section section-top-view">

          <div class="title">Select View</div>

          <div class="row">
            <div class="col col-md-12">
              <div class="view" ng-repeat="v in _.views track by v.id"
                   ng-class="{ active: v.id == _.selectedView.id }"
                   ng-click="_.selectedView = v"
              ><a href="">{{ v.name }}</a></div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="row">

      <div class="col col-md-3">
        <div class="section section-left">

          <div class="title">Tables & Data Fields</div>

          <ul>
            <li class="types" ng-repeat="t in _.getFieldTypes() track by $index">

              <span class="arrow" ng-class="{ open: _.dataFieldsByType[t].open }"></span>
              <div class="typeName" ng-click="_.dataFieldsByType[t].open = !_.dataFieldsByType[t].open">
                ABC
              </div>

              <ul class="fieldList" ng-class="{ open: _.dataFieldsByType[t].open }">
                <li class="fields" ng-repeat="f in _.dataFieldsByType[t].fields track by $index"
                     ng-class="{ active: f == _.selectedDataField }"
                     ng-click="_.selectedDataField = f"
                >{{ f }}</li>
              </ul>

            </li>
          </ul>

        </div>
      </div>

      <div class="col col-md-9">

        <div class="section section-right" ng-if="_.selectedView.id == 1">

          <div class="title"> Chart XYZ </div>

          <div class="chart-container">
            <div ng-if="_.showGrid" class="controls">

              <div class="sort">
                <span>sort: </span>
                <div class="view" ng-repeat="c in _.chartControlSort track by c.id"
                     ng-class="{ active: c.id == _.selectedChartControlSort.id }"
                     ng-click="_.selectedChartControlSort = c"
                ><a href="">{{ c.name }}</a></div>
              </div>

              <div class="scale">
                <span>scale: </span>
                <div class="view" ng-repeat="c in _.chartControlScale track by c.id"
                     ng-class="{ active: c.id == _.selectedChartControlScale.id }"
                     ng-click="_.selectedChartControlScale = c"
                ><a href="">{{ c.name }}</a></div>
              </div>

            </div>

            <div id="chart"></div>

            <div ng-if="_.showGrid" class="dropdown">
              <button class="dropbtn">Export</button>
              <div class="dropdown-content">
                <a href="" ng-click="_.click('png', $event)">PNG</a>
                <a href="" ng-click="_.click('pdf', $event)">PDF</a>
              </div>
            </div>

          </div>


          <div class="grid-container">
            <div ng-if="_.showGrid" ui-grid="_.gridOptions" class="grid"></div>

            <div ng-if="_.showGrid" class="dropdown">
              <button class="dropbtn">Export</button>
              <div class="dropdown-content">
                <a href="" ng-click="_.click('csv', $event)">CSV</a>
                <a href="" ng-click="_.click('json', $event)">JSON</a>
              </div>
            </div>

          </div>

        </div>

        <div class="section section-right" ng-if="_.selectedView.id == 0">
          <div class="title"> Summary </div>
        </div>

        <div class="section section-right" ng-if="_.selectedView.id == 2">
          <div class="title"> Statistics </div>
        </div>

      </div>

    </div>

  </div>

</body>
</html>